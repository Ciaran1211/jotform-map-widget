<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JotForm Widget Debug v3 - PostMessage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #cce5ff; color: #004085; }
        #log {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 8px;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h2>üîß JotForm Widget Debug v3 (PostMessage)</h2>
    
    <div id="status" class="status info">Checking...</div>
    
    <h3>Debug Log:</h3>
    <div id="log"></div>

    <script>
        function log(msg) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}\n`;
            console.log(msg);
        }
        
        function setStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = 'status ' + type;
            el.textContent = msg;
        }
        
        // Get query params
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        const qid = getQueryParam('qid');
        
        log('Page loaded');
        log('In iframe: ' + (window.self !== window.top));
        log('QID from URL: ' + qid);
        log('Using direct postMessage (no JotForm script)');
        
        // Custom JotForm Widget API using postMessage
        const JFWidget = {
            sendData: function(data) {
                const msg = {
                    type: 'data',
                    qid: qid,
                    value: data.value,
                    valid: data.valid
                };
                log('Sending data: ' + JSON.stringify(msg));
                window.parent.postMessage(JSON.stringify(msg), '*');
            },
            
            sendSubmit: function(data) {
                const msg = {
                    type: 'submit',
                    qid: qid,
                    value: data.value,
                    valid: data.valid
                };
                log('Sending submit: ' + JSON.stringify(msg));
                window.parent.postMessage(JSON.stringify(msg), '*');
            }
        };
        
        // Listen for messages from JotForm
        window.addEventListener('message', function(event) {
            log('Received message from: ' + event.origin);
            log('Message data: ' + (typeof event.data === 'string' ? event.data : JSON.stringify(event.data)));
            
            try {
                const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                
                if (data.type === 'ready') {
                    log('READY event received!');
                    setStatus('success', '‚úÖ Connected to JotForm!');
                }
                
                if (data.type === 'submit') {
                    log('SUBMIT event received!');
                    JFWidget.sendSubmit({ value: 'test-value', valid: true });
                }
            } catch (e) {
                log('Message parse note: ' + e.message);
            }
        });
        
        // Signal ready to JotForm
        if (window.self !== window.top && qid) {
            log('Signaling ready to parent...');
            JFWidget.sendData({ value: '', valid: true });
            setStatus('info', '‚è≥ Waiting for JotForm response...');
            
            // Also try the frameReady message format
            window.parent.postMessage(JSON.stringify({
                type: 'frameReady',
                qid: qid
            }), '*');
            log('Sent frameReady signal');
            
        } else {
            setStatus('error', '‚ùå Not in iframe or missing QID');
            log('Cannot connect - not in proper JotForm context');
        }
        
        // Timeout check
        setTimeout(function() {
            const status = document.getElementById('status');
            if (status.textContent.includes('Waiting')) {
                log('No response from JotForm after 5 seconds');
                log('Widget may still work - try submitting the form');
            }
        }, 5000);
    </script>
</body>
</html>
