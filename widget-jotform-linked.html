<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Drawing Widget - JotForm Linked</title>
    
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@8.2.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@8.2.0/dist/ol.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fb;
            color: #1a1f36;
            line-height: 1.5;
        }
        
        .widget-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            max-width: 100%;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        }
        
        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #e5e7eb;
        }
        
        .toolbar-group:last-child {
            border-right: none;
            padding-right: 0;
        }
        
        .tool-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            color: #374151;
            background: #f3f4f6;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .tool-btn:hover {
            background: #e5e7eb;
        }
        
        .tool-btn.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.3);
        }
        
        .tool-btn.danger {
            color: #dc2626;
        }
        
        .tool-btn.danger:hover {
            background: #fef2f2;
        }
        
        .tool-btn.primary {
            background: #059669;
            color: white;
        }
        
        .tool-btn.primary:hover {
            background: #047857;
        }
        
        .tool-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .map-wrapper {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.05);
        }
        
        #map {
            width: 100%;
            height: 400px;
            background: #e8ecf1;
        }
        
        .map-overlay {
            position: absolute;
            bottom: 12px;
            left: 12px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(8px);
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .feature-count {
            font-weight: 600;
            color: #2563eb;
        }
        
        .site-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            border-radius: 10px;
            color: white;
        }
        
        .site-header h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }
        
        .site-header p {
            font-size: 12px;
            opacity: 0.9;
            margin: 0;
        }
        
        .site-header .site-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .waiting-overlay {
            position: absolute;
            inset: 0;
            background: rgba(248, 249, 251, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 100;
        }
        
        .waiting-overlay.hidden {
            display: none;
        }
        
        .waiting-icon {
            width: 64px;
            height: 64px;
            border: 3px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .waiting-text {
            font-size: 14px;
            color: #6b7280;
            text-align: center;
        }
        
        .waiting-text strong {
            display: block;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
        }
        
        .status-dot.ready {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .status-dot.drawing {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .layer-selector {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }
        
        .layer-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 500;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .layer-btn:hover {
            background: #f3f4f6;
        }
        
        .layer-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
        }
        
        /* OpenLayers overrides */
        .ol-zoom {
            top: auto;
            bottom: 12px;
            right: 12px;
            left: auto;
        }
        
        .ol-zoom button {
            width: 32px;
            height: 32px;
            background: white;
            color: #374151;
            border-radius: 6px;
            font-size: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ol-zoom button:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="site-header" id="siteHeader">
            <div class="site-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
            </div>
            <div>
                <h4 id="siteName">Waiting for site selection...</h4>
                <p id="siteCompany">Select a site from the form above</p>
            </div>
        </div>
        
        <div class="toolbar" id="toolbar">
            <div class="toolbar-group">
                <button class="tool-btn" data-tool="Polygon" title="Draw Polygon" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12,2 22,8.5 22,15.5 12,22 2,15.5 2,8.5"/>
                    </svg>
                    Polygon
                </button>
                <button class="tool-btn" data-tool="Box" title="Draw Rectangle" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                    </svg>
                    Rectangle
                </button>
                <button class="tool-btn" data-tool="Circle" title="Draw Circle" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                    </svg>
                    Circle
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" data-tool="LineString" title="Draw Line" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 20L20 4"/>
                        <circle cx="4" cy="20" r="2" fill="currentColor"/>
                        <circle cx="20" cy="4" r="2" fill="currentColor"/>
                    </svg>
                    Line
                </button>
                <button class="tool-btn" data-tool="Point" title="Place Point" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" fill="currentColor"/>
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                    Point
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="tool-btn" id="undoBtn" title="Undo Last" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/>
                        <path d="M3 13a9 9 0 1 0 3-7.7L3 7"/>
                    </svg>
                    Undo
                </button>
                <button class="tool-btn danger" id="clearBtn" title="Clear All" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                    </svg>
                    Clear
                </button>
            </div>
            
            <div class="layer-selector">
                <button class="layer-btn" data-layer="osm">Street</button>
                <button class="layer-btn" data-layer="satellite">Satellite</button>
                <button class="layer-btn active" data-layer="ortho" id="orthoBtn">Ortho</button>
            </div>
        </div>
        
        <div class="map-wrapper">
            <div id="map"></div>
            <div class="map-overlay">
                Features drawn: <span class="feature-count" id="featureCount">0</span>
            </div>
            
            <!-- Waiting overlay shown until site is selected -->
            <div class="waiting-overlay" id="waitingOverlay">
                <div class="waiting-icon"></div>
                <div class="waiting-text">
                    <strong>Select a Site</strong>
                    Please choose a site from the dropdown above to load the map.
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Waiting for site selection</span>
            </div>
            <span id="coordDisplay">--</span>
        </div>
    </div>

    <script>
        // ============================================
        // JotForm-Linked Map Drawing Widget
        // ============================================
        // This widget receives site selection from JotForm
        // via URL parameter or postMessage
        // ============================================
        
        (async function() {
            'use strict';
            
            const S3_BASE_URL = 'https://s3-map-tiles.s3.ap-southeast-2.amazonaws.com';
            
            // ============================================
            // CONFIGURATION
            // ============================================
            // You can either:
            // 1. Load from sites.json file
            // 2. Define inline (uncomment SITES_CONFIG below)
            // ============================================
            
            let SITES_CONFIG = null;
            
            // Try to load sites.json
            try {
                const response = await fetch('sites-hierarchical.json');
                if (response.ok) {
                    SITES_CONFIG = await response.json();
                    console.log('Loaded sites config:', SITES_CONFIG);
                }
            } catch (e) {
                console.log('Could not load sites-hierarchical.json, using inline config');
            }
            
            // Fallback inline config (edit this if not using sites.json)
            if (!SITES_CONFIG) {
                SITES_CONFIG = {
                    companies: {
                        "bma": { name: "BMA", sites: ["saraji", "peak-downs", "goonyella"] },
                        "other": { name: "Other", sites: ["binduli-north"] }
                    },
                    sites: {
                        "binduli-north": {
                            name: "Binduli North",
                            company: "other",
                            tileUrl: S3_BASE_URL + "/sites/binduli-north/{z}/{x}/{y}.png",
                            center: [121.3825, -30.775],
                            minZoom: 14,
                            maxZoom: 21,
                            defaultZoom: 17
                        }
                    }
                };
            }
            
            // ============================================
            // STATE
            // ============================================
            
            let map = null;
            let drawSource = null;
            let drawInteraction = null;
            let orthoLayer = null;
            let currentSite = null;
            let featureHistory = [];
            
            const CONFIG = {
                defaultCenter: [134, -25],  // Australia center
                defaultZoom: 4,
                maxZoom: 21,
                drawStyle: {
                    fillColor: 'rgba(37, 99, 235, 0.2)',
                    strokeColor: '#2563eb',
                    strokeWidth: 2,
                    pointRadius: 6
                }
            };
            
            // Base layers
            const osmLayer = new ol.layer.Tile({
                source: new ol.source.OSM(),
                visible: false
            });
            
            const satelliteLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    maxZoom: 19
                }),
                visible: false
            });
            
            // Drawing style
            const drawStyle = new ol.style.Style({
                fill: new ol.style.Fill({ color: CONFIG.drawStyle.fillColor }),
                stroke: new ol.style.Stroke({ 
                    color: CONFIG.drawStyle.strokeColor, 
                    width: CONFIG.drawStyle.strokeWidth 
                }),
                image: new ol.style.Circle({
                    radius: CONFIG.drawStyle.pointRadius,
                    fill: new ol.style.Fill({ color: CONFIG.drawStyle.strokeColor }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                })
            });
            
            // ============================================
            // URL PARAMETER HANDLING
            // ============================================
            
            function getUrlParam(name) {
                const params = new URLSearchParams(window.location.search);
                return params.get(name);
            }
            
            // ============================================
            // SITE LOADING
            // ============================================
            
            function loadSite(siteId) {
                const siteConfig = SITES_CONFIG.sites[siteId];
                
                if (!siteConfig) {
                    console.error('Site not found:', siteId);
                    updateStatus('error', 'Site not found: ' + siteId);
                    return false;
                }
                
                console.log('Loading site:', siteId, siteConfig);
                currentSite = siteConfig;
                
                // Update header
                document.getElementById('siteName').textContent = siteConfig.name;
                const company = SITES_CONFIG.companies[siteConfig.company];
                document.getElementById('siteCompany').textContent = company ? company.name : '';
                
                // Create or update ortho layer
                if (orthoLayer) {
                    map.removeLayer(orthoLayer);
                }
                
                orthoLayer = new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: siteConfig.tileUrl,
                        minZoom: siteConfig.minZoom || 14,
                        maxZoom: siteConfig.maxZoom || 21
                    }),
                    visible: true
                });
                
                // Insert ortho layer below draw layer
                const layers = map.getLayers();
                layers.insertAt(layers.getLength() - 1, orthoLayer);
                
                // Hide other base layers, show ortho
                osmLayer.setVisible(false);
                satelliteLayer.setVisible(false);
                
                // Update layer buttons
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.layer === 'ortho');
                });
                
                // Animate to site location
                map.getView().animate({
                    center: ol.proj.fromLonLat(siteConfig.center),
                    zoom: siteConfig.defaultZoom || 17,
                    duration: 1000
                });
                
                // Hide waiting overlay
                document.getElementById('waitingOverlay').classList.add('hidden');
                
                // Enable tools
                enableTools(true);
                
                updateStatus('ready', 'Ready - Select a tool to begin drawing');
                
                // Send update to JotForm
                sendDataToJotForm();
                
                return true;
            }
            
            function enableTools(enabled) {
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.disabled = !enabled;
                });
                document.getElementById('undoBtn').disabled = !enabled;
                document.getElementById('clearBtn').disabled = !enabled;
            }
            
            // ============================================
            // MAP INITIALIZATION
            // ============================================
            
            function initMap() {
                drawSource = new ol.source.Vector();
                
                const drawLayer = new ol.layer.Vector({
                    source: drawSource,
                    style: drawStyle
                });
                
                map = new ol.Map({
                    target: 'map',
                    layers: [osmLayer, satelliteLayer, drawLayer],
                    view: new ol.View({
                        center: ol.proj.fromLonLat(CONFIG.defaultCenter),
                        zoom: CONFIG.defaultZoom,
                        maxZoom: CONFIG.maxZoom
                    }),
                    controls: ol.control.defaults.defaults().extend([
                        new ol.control.ScaleLine()
                    ])
                });
                
                // Track mouse position
                map.on('pointermove', function(evt) {
                    const coords = ol.proj.toLonLat(evt.coordinate);
                    document.getElementById('coordDisplay').textContent = 
                        `${coords[1].toFixed(5)}, ${coords[0].toFixed(5)}`;
                });
                
                drawSource.on('change', updateFeatureCount);
            }
            
            // ============================================
            // DRAWING TOOLS
            // ============================================
            
            function setDrawTool(toolType) {
                if (drawInteraction) {
                    map.removeInteraction(drawInteraction);
                    drawInteraction = null;
                }
                
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tool === toolType);
                });
                
                if (!toolType) {
                    updateStatus('ready', 'Ready - Select a tool to begin');
                    return;
                }
                
                const drawOptions = {
                    source: drawSource,
                    style: drawStyle
                };
                
                if (toolType === 'Box') {
                    drawOptions.type = 'Circle';
                    drawOptions.geometryFunction = ol.interaction.Draw.createBox();
                } else if (toolType === 'Circle') {
                    drawOptions.type = 'Circle';
                } else {
                    drawOptions.type = toolType;
                }
                
                drawInteraction = new ol.interaction.Draw(drawOptions);
                
                drawInteraction.on('drawstart', function() {
                    updateStatus('drawing', `Drawing ${toolType}...`);
                });
                
                drawInteraction.on('drawend', function(evt) {
                    featureHistory.push(evt.feature);
                    updateStatus('ready', `${toolType} added - Draw more or select another tool`);
                    sendDataToJotForm();
                });
                
                map.addInteraction(drawInteraction);
                updateStatus('ready', `${toolType} tool active - Click map to draw`);
            }
            
            function undoLast() {
                if (featureHistory.length > 0) {
                    const lastFeature = featureHistory.pop();
                    drawSource.removeFeature(lastFeature);
                    sendDataToJotForm();
                    updateStatus('ready', 'Last feature removed');
                }
            }
            
            function clearAll() {
                if (drawSource.getFeatures().length === 0) return;
                
                if (confirm('Clear all drawn features?')) {
                    drawSource.clear();
                    featureHistory = [];
                    sendDataToJotForm();
                    updateStatus('ready', 'All features cleared');
                }
            }
            
            function updateFeatureCount() {
                document.getElementById('featureCount').textContent = drawSource.getFeatures().length;
            }
            
            function updateStatus(state, text) {
                const dot = document.getElementById('statusDot');
                const textEl = document.getElementById('statusText');
                dot.className = 'status-dot ' + state;
                textEl.textContent = text;
            }
            
            // ============================================
            // LAYER SWITCHING
            // ============================================
            
            function switchLayer(layerType) {
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.layer === layerType);
                });
                
                osmLayer.setVisible(layerType === 'osm');
                satelliteLayer.setVisible(layerType === 'satellite');
                
                if (orthoLayer) {
                    orthoLayer.setVisible(layerType === 'ortho');
                    
                    if (layerType === 'ortho' && currentSite) {
                        map.getView().animate({
                            center: ol.proj.fromLonLat(currentSite.center),
                            zoom: currentSite.defaultZoom || 17,
                            duration: 500
                        });
                    }
                }
            }
            
            // ============================================
            // KML GENERATION
            // ============================================
            
            function generateKML() {
                const features = drawSource.getFeatures();
                if (features.length === 0) return '';
                
                const clonedFeatures = features.map(f => {
                    const clone = f.clone();
                    const geom = clone.getGeometry();
                    
                    if (geom.getType() === 'Circle') {
                        const polygon = ol.geom.Polygon.fromCircle(geom, 64);
                        polygon.transform('EPSG:3857', 'EPSG:4326');
                        clone.setGeometry(polygon);
                    } else {
                        geom.transform('EPSG:3857', 'EPSG:4326');
                    }
                    
                    return clone;
                });
                
                let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${currentSite ? currentSite.name : 'Map Drawing'}</name>
    <description>Generated from JotForm Map Widget</description>
    <Style id="defaultStyle">
      <LineStyle><color>ffeb6325</color><width>2</width></LineStyle>
      <PolyStyle><color>33eb6325</color></PolyStyle>
    </Style>
`;
                
                clonedFeatures.forEach((feature, index) => {
                    const geom = feature.getGeometry();
                    const type = geom.getType();
                    
                    kml += `    <Placemark>
      <name>Feature ${index + 1}</name>
      <styleUrl>#defaultStyle</styleUrl>
`;
                    
                    if (type === 'Point') {
                        const coords = geom.getCoordinates();
                        kml += `      <Point><coordinates>${coords[0]},${coords[1]},0</coordinates></Point>\n`;
                    } else if (type === 'LineString') {
                        const coords = geom.getCoordinates();
                        kml += `      <LineString><coordinates>${coords.map(c => `${c[0]},${c[1]},0`).join(' ')}</coordinates></LineString>\n`;
                    } else if (type === 'Polygon') {
                        const coords = geom.getCoordinates()[0];
                        kml += `      <Polygon><outerBoundaryIs><LinearRing><coordinates>${coords.map(c => `${c[0]},${c[1]},0`).join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon>\n`;
                    }
                    
                    kml += `    </Placemark>\n`;
                });
                
                kml += `  </Document>\n</kml>`;
                return kml;
            }
            
            // ============================================
            // JOTFORM INTEGRATION
            // ============================================
            
            const jfQid = getUrlParam('qid');
            const isInJotForm = (window.self !== window.top) && jfQid;
            
            const JFWidget = {
                sendData: function(data) {
                    if (!isInJotForm) return;
                    window.parent.postMessage(JSON.stringify({
                        type: 'data',
                        qid: jfQid,
                        value: data.value,
                        valid: data.valid
                    }), '*');
                },
                sendSubmit: function(data) {
                    if (!isInJotForm) return;
                    window.parent.postMessage(JSON.stringify({
                        type: 'submit',
                        qid: jfQid,
                        value: data.value,
                        valid: data.valid
                    }), '*');
                }
            };
            
            function sendDataToJotForm() {
                const kml = generateKML();
                const featureCount = drawSource ? drawSource.getFeatures().length : 0;
                
                JFWidget.sendData({
                    value: kml,
                    valid: true  // Set to featureCount > 0 if drawing is required
                });
            }
            
            function initJotFormWidget() {
                if (!isInJotForm) {
                    console.log('Running outside JotForm - standalone mode');
                    return;
                }
                
                console.log('Initializing JotForm widget, QID:', jfQid);
                
                JFWidget.sendData({ value: '', valid: true });
                
                window.parent.postMessage(JSON.stringify({
                    type: 'frameReady',
                    qid: jfQid
                }), '*');
                
                // Listen for messages from JotForm (including site selection)
                window.addEventListener('message', function(event) {
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        
                        // Handle site selection from JotForm
                        if (data.type === 'selectSite' && data.siteId) {
                            console.log('Received site selection:', data.siteId);
                            loadSite(data.siteId);
                        }
                        
                        // Handle form submission
                        if (data.type === 'submit') {
                            const kml = generateKML();
                            JFWidget.sendSubmit({ value: kml, valid: true });
                        }
                    } catch (e) {
                        // Ignore non-JSON messages
                    }
                });
            }
            
            // ============================================
            // EVENT LISTENERS
            // ============================================
            
            function initEventListeners() {
                document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.disabled) return;
                        const tool = this.dataset.tool;
                        if (this.classList.contains('active')) {
                            setDrawTool(null);
                        } else {
                            setDrawTool(tool);
                        }
                    });
                });
                
                document.getElementById('undoBtn').addEventListener('click', undoLast);
                document.getElementById('clearBtn').addEventListener('click', clearAll);
                
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        switchLayer(this.dataset.layer);
                    });
                });
                
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') setDrawTool(null);
                    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); undoLast(); }
                });
            }
            
            // ============================================
            // INITIALIZATION
            // ============================================
            
            function init() {
                try {
                    initMap();
                    initEventListeners();
                    initJotFormWidget();
                    
                    // Check for site in URL parameter
                    const urlSite = getUrlParam('site');
                    if (urlSite) {
                        loadSite(urlSite);
                    }
                    
                } catch (e) {
                    console.error('Widget initialization error:', e);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>
